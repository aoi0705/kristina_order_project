{% extends "kseurasia_manage_app/base_dashboard.html" %}
{% load static %}

{% block title %}インポート記録一覧 | KS Eurasia{% endblock %}
{% block header %}インポート記録一覧{% endblock %}

{% block content %}
  <style>
    .table-wrap{ overflow:auto; }
    table.batches{ width:100%; border-collapse:collapse; background:#fff; }
    table.batches th, table.batches td{
      text-align:left; padding:10px 12px; border-bottom:1px solid #e5e7eb; white-space:nowrap;
    }
    table.batches thead th{
      position:sticky; top:0; z-index:1; background:#fafcff; font-weight:600; color:#0c4a6e;
    }
    .radio{ width:16px; height:16px; }
    .btn[disabled]{ opacity:.55; cursor:not-allowed; }
    /* 簡易モーダル */
    #confirm-delete-modal{ display:none; position:fixed; inset:0; background:rgba(0,0,0,.35); align-items:center; justify-content:center; z-index:2200;}
    #confirm-delete-modal .dialog{ width:520px; background:#fff; border:1px solid #e5e7eb; border-radius:14px; box-shadow:0 8px 24px rgba(0,0,0,.18); padding:20px; }
  </style>

  <!-- フィルタ -->
  <section class="card">
    <div class="card-header">
      <div>
        <div style="font-weight:700;">インポート記録一覧</div>
        <div class="muted" style="font-size:12px;">ファイル名／シート名／作成日時で絞り込みできます</div>
      </div>
    </div>
    <div class="card-body">
      <form method="get" class="row" action="{% url 'import_batch_list' %}">
        <div class="col" style="min-width:260px;">
          <label class="muted" for="q">検索（ファイル名 / シート名 / バッチID）</label>
          <input id="q" name="q" type="text" value="{{ q|default:'' }}"
                 style="width:100%; height:40px; border:1px solid #e5e7eb; border-radius:10px; padding:8px 10px; background:#fff;">
        </div>
        <div class="col" style="min-width:200px;">
          <label class="muted" for="from">作成日 From</label>
          <input id="from" name="from" type="date" value="{{ date_from|default:'' }}"
                 style="width:100%; height:40px; border:1px solid #e5e7eb; border-radius:10px; padding:8px 10px; background:#fff;">
        </div>
        <div class="col" style="min-width:200px;">
          <label class="muted" for="to">作成日 To</label>
          <input id="to" name="to" type="date" value="{{ date_to|default:'' }}"
                 style="width:100%; height:40px; border:1px solid #e5e7eb; border-radius:10px; padding:8px 10px; background:#fff;">
        </div>
        <div class="col" style="align-self:flex-end; min-width:220px; display:flex; gap:10px;">
          <button class="btn btn-primary" type="submit">検索</button>
          <a class="btn" href="{% url 'import_batch_list' %}">リセット</a>
        </div>
      </form>
    </div>
  </section>

  <!-- 一覧 -->
  <section class="card" style="margin-top:16px;">
    <div class="card-body">
      <div class="table-wrap">
        <table class="batches">
          <thead>
            <tr>
              <th style="width:56px;">選択</th>
              <th style="width:90px;">バッチID</th>
              <th>ファイル名</th>
              <th style="width:160px;">シート名</th>
              <th style="width:120px;">取り込み件数</th>
              <th style="width:160px;">作成日時</th>
              <th style="width:160px;">発注書</th>
              <th style="width:220px;">インボイス・パッキング</th>
              <th style="width:160px;">オーダー一覧</th>
              <th style="width:110px;">削除</th>
            </tr>
          </thead>
          <tbody>
            {% if page_obj.object_list %}
              {% for b in page_obj.object_list %}
                <tr data-batch-id="{{ b.id }}" data-buyers="{{ b.buyers|default:'' }}">
                  <td>
                    <input class="radio" type="radio" name="batch_id" value="{{ b.id }}">
                  </td>
                  <td>#{{ b.id }}</td>
                  <td title="{{ b.source_filename }}">{{ b.source_filename|default:"(不明)" }}</td>
                  <td>{{ b.sheet_name|default:"(未指定)" }}</td>
                  <td>{{ b.item_count|default:"-" }}</td>
                  <td>{{ b.created_at|date:"Y-m-d H:i" }}</td>
                  <td>
                    <a class="btn" href="{% url 'download_purchase_order' b.id %}">発注書ダウンロード</a>
                  </td>
                  <td>
                    {% if b.buyers == "YAMATO_TOYO" %}
                      <span class="btn" disabled>IV/PLは対象外</span>
                    {% else %}
                      <a class="btn" href="{% url 'export_invoice_packing' b.id %}">IVPLダウンロード</a>
                    {% endif %}
                  </td>
                  <td>
                    <a class="btn" href="{% url 'batch_order_list' batch_id=b.id %}">このバッチのオーダー</a>
                  </td>
                  <td>
                    <button class="btn btn-danger btn-sm js-delete"
                            data-id="{{ b.id }}"
                            data-name="#{{ b.id }} {{ b.source_filename|default:'(不明)'}}">
                      削除
                    </button>
                  </td>
                </tr>
              {% endfor %}
            {% else %}
              <tr><td colspan="10" class="muted" style="padding:16px 12px;">データがありません。</td></tr>
            {% endif %}
          </tbody>
        </table>
      </div>

      <!-- 下部ツールバー -->
      <div style="display:flex; gap:10px; align-items:center; border-top:1px solid #e5e7eb; padding-top:12px; margin-top:12px;">
        </form>

        <!-- ページング（右寄せ） -->
        <div style="margin-left:auto; display:flex; gap:6px; align-items:center;">
          {% if page_obj.has_previous %}
            <a class="btn" href="?page=1{% if q %}&q={{ q }}{% endif %}{% if date_from %}&from={{ date_from }}{% endif %}{% if date_to %}&to={{ date_to }}{% endif %}">« 最初</a>
            <a class="btn" href="?page={{ page_obj.previous_page_number }}{% if q %}&q={{ q }}{% endif %}{% if date_from %}&from={{ date_from }}{% endif %}{% if date_to %}&to={{ date_to }}{% endif %}">‹ 前</a>
          {% endif %}
          <span class="btn" style="background:#eef6ff; border-color:#cfe8ff;">{{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span>
          {% if page_obj.has_next %}
            <a class="btn" href="?page={{ page_obj.next_page_number }}{% if q %}&q={{ q }}{% endif %}{% if date_from %}&from={{ date_from }}{% endif %}{% if date_to %}&to={{ date_to }}{% endif %}">次 ›</a>
            <a class="btn" href="?page={{ page_obj.paginator.num_pages }}{% if q %}&q={{ q }}{% endif %}{% if date_from %}&from={{ date_from }}{% endif %}{% if date_to %}&to={{ date_to }}{% endif %}">最後 »</a>
          {% endif %}
        </div>
      </div>
    </div>
  </section>

  <!-- 削除モーダル -->
  <div id="confirm-delete-modal">
    <div class="dialog">
      <h3 style="margin:0 0 6px;">バッチ削除の確認</h3>
      <p id="confirm-text" class="muted" style="margin:8px 0 16px;">
        選択したバッチを削除します。関連するオーダーもすべて削除されます。よろしいですか？
      </p>
      <div style="display:flex; gap:8px; justify-content:flex-end;">
        <button class="btn" id="cancel-delete">キャンセル</button>
        <form id="delete-form" method="post">
          {% csrf_token %}
          <button type="submit" class="btn btn-danger">削除する</button>
        </form>
      </div>
    </div>
  </div>

  <script>
    // ラジオ選択でボタン活性化＆POST先URLを設定
    (function(){
      const radios = document.querySelectorAll('input[name="batch_id"]');
      const btnPO = document.querySelector('#form-po button');
      const btnIP = document.querySelector('#form-ip button');
      const inputPO = document.querySelector('#po-batch-id');
      const inputIP = document.querySelector('#ip-batch-id');
      const formPO = document.querySelector('#form-po');
      const formIP = document.querySelector('#form-ip');

      function onSelect(id, buyers){
        inputPO.value = id;
        inputIP.value = id;
        formPO.action = `/imports/${id}/export/purchase-order/`;
        formIP.action = `/imports/${id}/export/invoice-packing/`;

        // 有効/無効（YAMATOはIVPL不可）
        btnPO.disabled = false;
        if (buyers === 'YAMATO_TOYO') {
          btnIP.disabled = true;
        } else {
          btnIP.disabled = false;
        }
      }

      radios.forEach(r=>{
        r.addEventListener('change', (e)=>{
          const tr = e.target.closest('tr');
          const buyers = tr ? tr.dataset.buyers : '';
          onSelect(e.target.value, buyers);
        });
      });
    })();

    // 削除モーダル
    (function(){
      const modal = document.getElementById('confirm-delete-modal');
      const confirmText = document.getElementById('confirm-text');
      const deleteForm = document.getElementById('delete-form');
      const cancelBtn = document.getElementById('cancel-delete');

      document.querySelectorAll('.js-delete').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const id = btn.dataset.id;
          const name = btn.dataset.name || ('#' + id);
          confirmText.textContent = `「${name}」を削除します。関連オーダーも削除されます。よろしいですか？`;
          deleteForm.action = `/imports/${id}/delete/`;
          modal.style.display = 'flex';
        });
      });
      cancelBtn.addEventListener('click', ()=> modal.style.display = 'none');
      modal.addEventListener('click', (e)=> { if (e.target === modal) modal.style.display = 'none'; });
    })();
  </script>
{% endblock %}
