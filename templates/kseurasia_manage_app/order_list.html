{% extends "kseurasia_manage_app/base_dashboard.html" %}
{% load static %}

{% block title %}登録オーダー | KS Eurasia{% endblock %}
{% block header %}登録オーダー一覧{% endblock %}

{% block content %}
  <style>
    .table-wrap { overflow:auto; }
    table.orders { width:100%; border-collapse:collapse; background:#fff; }
    table.orders th, table.orders td {
      text-align:left; padding:10px 12px; border-bottom:1px solid #e5e7eb; white-space:nowrap;
    }
    table.orders thead th {
      position: sticky; top: 0; z-index: 1; background:#fafcff; font-weight:600; color:#0c4a6e;
    }
    .rowlink { cursor:pointer; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
    .filters .col { min-width:220px; }
  </style>

  <!-- フィルタ -->
  <section class="card">
    <div class="card-header">
      <div>
        <div style="font-weight:700;">登録オーダー一覧</div>
        <div class="muted" style="font-size:12px;">件数：{{ total_count }}件</div>
      </div>
      <div></div>
    </div>
    <div class="card-body">
      <form class="row filters" method="get" action="{% url 'order_list' %}">
        <div class="col">
          <label class="muted" for="batch">バッチ（取り込み）</label>
          <select id="batch" name="batch" style="height:40px; border:1px solid #e5e7eb; border-radius:10px; padding:6px 10px; background:#fff;" onchange="this.form.submit()">
            <option value="">すべて</option>
            {% for b in batches %}
              <option value="{{ b.id }}" {% if selected_batch_id|default:'' == b.id|stringformat:'s' %}selected{% endif %}>
                {{ b.created_at|date:"Y-m-d H:i" }} — {{ b.source_filename|default:"(no filename)" }}
              </option>
            {% endfor %}
          </select>
        </div>
        <div class="col" style="flex:1;">
          <label class="muted" for="q">キーワード（JAN / 商品名 / ブランド / SKU）</label>
          <div style="display:flex; gap:8px;">
            <input id="q" name="q" type="text" value="{{ q|default:'' }}"
                   style="width:100%; height:40px; border:1px solid #e5e7eb; border-radius:10px; padding:8px 10px; background:#fff;">
            {% if selected_batch_id %}
              <input type="hidden" name="batch" value="{{ selected_batch_id }}">
            {% endif %}
            <button class="btn btn-primary" type="submit">検索</button>
            <a class="btn" href="{% url 'import_orders' %}">Excel取り込み</a>
          </div>
        </div>
      </form>
    </div>
  </section>

  <!-- 一覧 -->
  <section class="card" style="margin-top:16px;">
    <div class="card-body">
      <div class="table-wrap" style="max-height:70vh;">
        <table class="orders">
          <thead>
            <tr>
              <th style="width:70px;">ID</th>
              <th style="width:160px;">取込時刻</th>
              <th>商品名</th>
              <th style="width:160px;">ブランド</th>
              <th style="width:140px;">JAN</th>
              <th style="width:140px;">SKU</th>
              <th style="width:100px; text-align:right;">数量</th>
              <th style="width:140px; text-align:right;">金額</th>
            </tr>
          </thead>
          <tbody>
            {% for it in page_obj.object_list %}
              <tr class="rowlink" onclick="location.href='{% url 'order_detail' it.id %}'">
                <td><a href="{% url 'order_detail' it.id %}" class="text-decoration-none">#{{ it.id }}</a></td>
                <td class="mono">{{ it.batch.created_at|date:"Y-m-d H:i" }}</td>
                <td>{{ it.Product_name }}</td>
                <td>{{ it.Brand_name }}</td>
                <td class="mono">{{ it.Jan_code }}</td>
                <td class="mono">{{ it.SKU_number }}</td>
                <td style="text-align:right;">{{ it.Order }}</td>
                <td style="text-align:right;">{{ it.Amount }}</td>
              </tr>
            {% empty %}
              <tr><td colspan="8" class="muted" style="padding:16px 12px;">データがありません。</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- ページネーション -->
      <div style="display:flex; gap:6px; align-items:center; justify-content:center; margin-top:12px;">
        {% if page_obj.has_previous %}
          <a class="btn" href="?{% if selected_batch_id %}batch={{selected_batch_id}}&{% endif %}{% if q %}q={{q}}&{% endif %}page={{ page_obj.previous_page_number }}">前へ</a>
        {% else %}
          <span class="btn" style="opacity:.5; cursor:not-allowed;">前へ</span>
        {% endif %}

        <span class="btn" style="background:#eef6ff; border-color:#cfe8ff;">{{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span>

        {% if page_obj.has_next %}
          <a class="btn" href="?{% if selected_batch_id %}batch={{selected_batch_id}}&{% endif %}{% if q %}q={{q}}&{% endif %}page={{ page_obj.next_page_number }}">次へ</a>
        {% else %}
          <span class="btn" style="opacity:.5; cursor:not-allowed;">次へ</span>
        {% endif %}
      </div>
    </div>
  </section>
{% endblock %}
