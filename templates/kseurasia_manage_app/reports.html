{% extends "kseurasia_manage_app/base_dashboard.html" %}

{% block title %}レポート発行 | KS Eurasia{% endblock %}
{% block header %}レポート発行（一括ZIP）{% endblock %}

{% block content %}
  <section class="card">
    <div class="card-header">
      <div>
        <div style="font-weight:700;">期間を指定して4レポートを一括ダウンロード</div>
        <div class="muted" style="font-size:12px;">売上表 / 売掛金管理表 / 買掛金管理表 / 収支予定表</div>
      </div>
    </div>
    <div class="card-body">
      <form id="reportForm" class="row" onsubmit="return false;">
        <div class="col">
          <label for="start_month">開始年月</label>
          <input id="start_month" name="start_month" type="month" />
        </div>
        <div class="col">
          <label for="end_month">終了年月</label>
          <input id="end_month" name="end_month" type="month" />
        </div>
        <div class="col" style="align-self:flex-end;">
          <button id="zipAllBtn" class="btn btn-primary" type="button">4レポート一括ZIPダウンロード</button>
        </div>
      </form>
    </div>
  </section>

  <script>
    const overlayEl = document.getElementById('loading-overlay');
    function showOverlay(msg){
      if (!overlayEl) return;
      if (msg) { const m = overlayEl.querySelector('.msg'); if (m) m.textContent = msg; }
      overlayEl.classList.add('is-active');
    }
    function hideOverlay(){ overlayEl?.classList.remove('is-active'); }

    // 相互 min/max & 初期値（当月）
    (function initMonthRange(){
      const sm = document.getElementById('start_month');
      const em = document.getElementById('end_month');
      if(!sm || !em) return;
      const d = new Date();
      const ym = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
      if(!sm.value) sm.value = ym;
      if(!em.value) em.value = ym;
      em.min = sm.value || '';
      sm.max = em.value || '';
      sm.addEventListener('change', ()=>{ if (em.value && sm.value > em.value) em.value = sm.value; em.min = sm.value || ''; });
      em.addEventListener('change', ()=>{ if (sm.value && em.value < sm.value) sm.value = em.value; sm.max = em.value || ''; });
    })();

    function getRange(){
      const sm = (document.getElementById('start_month')?.value || '').trim();
      const em = (document.getElementById('end_month')?.value || '').trim();
      return { start: sm, end: em };
    }
    function ensureParams({start,end}){
      if(!start || !end){ alert('開始年月と終了年月を入力してください'); return false; }
      if(start > end){ alert('開始年月は終了年月以前にしてください'); return false; }
      return true;
    }

    async function downloadZipAll(){
      const { start, end } = getRange();
      if(!ensureParams({start,end})) return;

      const btn = document.getElementById('zipAllBtn');
      btn.disabled = true;

      const url = new URL("/api/reports/export-all", window.location.origin);
      url.searchParams.set("start_month", start);
      url.searchParams.set("end_month", end);

      // 共有オーバーレイを表示
      showOverlay('処理中...'); 

      try {
        const resp = await fetch(url, { method: 'GET', cache: 'no-store' });
        if(!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const blob = await resp.blob();
        const cd = resp.headers.get('Content-Disposition') || '';
        const m = cd.match(/filename="([^"]+)"/);
        const filename = m ? decodeURIComponent(m[1]) : `Reports_${start}_${end}.zip`;

        const a = document.createElement('a');
        const href = URL.createObjectURL(blob);
        a.href = href; a.download = filename;
        document.body.appendChild(a); a.click(); a.remove();
        URL.revokeObjectURL(href);
      } catch(e){
        alert('ダウンロードに失敗しました。\n' + e.message);
      } finally {
        btn.disabled = false;
        hideOverlay();
      }
    }

    document.getElementById('zipAllBtn')?.addEventListener('click', downloadZipAll);
  </script>
{% endblock %}
