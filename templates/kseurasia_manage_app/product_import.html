{% extends "kseurasia_manage_app/base_dashboard.html" %}
{% load static %}

{% block title %}商品登録 | KS Eurasia{% endblock %}
{% block header %}商品登録（インポート / 更新）{% endblock %}

{% block content %}
  <section class="card">
    <div class="card-header">
      <div>
        <div style="font-weight:700;">商品マスタの一括登録／更新</div>
        <div class="muted" style="font-size:12px;">
          対応ファイル例：Excel（.xlsx / .xlsm）{% verbatim %}{% endverbatim %}{# CSV等に対応している場合は文言を追記してください #}
        </div>
      </div>
    </div>

    <div class="card-body">
      {# Djangoのビューで form を渡している場合はスタイル付きでレンダリング #}
      {% if form %}
        <form method="post" enctype="multipart/form-data" action="">
          {% csrf_token %}
          <div class="row">
            {% for field in form.visible_fields %}
              <div class="col">
                <label for="{{ field.id_for_label }}">{{ field.label }}</label>
                {{ field }}
                {% if field.help_text %}<div class="hint">{{ field.help_text }}</div>{% endif %}
                {% for err in field.errors %}<div class="hint" style="color:#b91c1c;">{{ err }}</div>{% endfor %}
              </div>
            {% endfor %}
          </div>
          {% if form.non_field_errors %}
            <div class="hint" style="color:#b91c1c; margin-top:8px;">
              {{ form.non_field_errors }}
            </div>
          {% endif %}
          <div style="margin-top:16px; display:flex; gap:10px;">
            <button id="productImportBtn" class="btn btn-primary" type="submit">アップロードして登録/更新</button>
            <a class="btn" href="/products/">商品一覧へ</a>
          </div>
        </form>
      {% else %}
        {# form が渡っていない場合のフォールバック（最小構成） #}
        <form method="post" enctype="multipart/form-data" action="">
          {% csrf_token %}
          <div class="row">
            <div class="col">
              <label for="file">ファイル</label>
              <input id="file" name="file" type="file" accept=".xlsx,.xlsm" required>
              <div class="hint">必要に応じて取り込み先や列マッピングはサーバ側設定に従います。</div>
            </div>
            <div class="col">
              <label for="sheet_name">シート名（任意）</label>
              <input id="sheet_name" name="sheet_name" type="text" placeholder="未指定時は先頭シート">
            </div>
          </div>
          <div style="margin-top:16px; display:flex; gap:10px;">
            <button id="productImportBtn" class="btn btn-primary" type="submit">アップロードして登録/更新</button>
            <a class="btn" href="/products/">商品一覧へ</a>
          </div>
        </form>
      {% endif %}
    </div>
  </section>

  <script>
    // 取り込み送信時に共通オーバーレイを表示
    const overlayEl = document.getElementById('loading-overlay');
    function showOverlay(msg){
      if (!overlayEl) return;
      if (msg) { const m = overlayEl.querySelector('.msg'); if (m) m.textContent = msg; }
      overlayEl.classList.add('is-active');
    }
    function hideOverlay(){ overlayEl?.classList.remove('is-active'); }

    const form = document.querySelector('form');
    if (form) {
    form.addEventListener('submit', function(e){
      e.preventDefault();               // いったん止める
      showOverlay('処理中...');        // ここで確実に表示
      requestAnimationFrame(() => {
        requestAnimationFrame(() => {
          HTMLFormElement.prototype.submit.call(form);  // ネイティブ送信
        });
      });
    });
  }
  </script>
{% endblock %}
