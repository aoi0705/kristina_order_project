{% extends "kseurasia_manage_app/base_dashboard.html" %}
{% load dynattrs %}

{% block title %}商品一覧 | KS Eurasia{% endblock %}
{% block header %}商品一覧（{{ vendor_label }}）{% endblock %}

{% block content %}
  <style>
    /* このページのテーブル微調整（baseのトーンに合わせる） */
    .table-wrap { overflow:auto; }
    table.prod-table { width:100%; border-collapse:collapse; background:#fff; }
    table.prod-table th, table.prod-table td {
      text-align:left; padding:10px 12px; border-bottom:1px solid #e5e7eb; white-space:nowrap;
    }
    table.prod-table thead th {
      position: sticky; top: 0; z-index: 1; background:#fafcff; font-weight:600; color:#0c4a6e;
    }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
    .required-row > td { background:#FFF3E0; }
  </style>

  <section class="card">
    <div class="card-header">
      <div>
        <div style="font-weight:700;">商品マスタ一覧</div>
        <div class="muted" style="font-size:12px;">
          表示中：{{ vendor_label }}　／　総件数：{{ page_obj.paginator.count }}件
        </div>
      </div>
      <div style="display:flex; gap:10px; align-items:center;">
        <label for="vendor" style="margin:0; font-size:12px;" class="muted">ベンダー</label>
        <select id="vendor" name="vendor" style="height:36px; border:1px solid #e5e7eb; border-radius:10px; padding:6px 10px; background:#fff;">
          {% for val,label in vendor_choices %}
            <option value="{{ val }}" {% if val == vendor %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
        <a class="btn" href="/products/import/?vendor={{ vendor }}">商品登録（インポート）</a>
      </div>
    </div>

    <div class="card-body">
      <div class="table-wrap">
        <table class="prod-table">
          <thead>
            <tr>
              <th style="width:80px;">ID</th>
              {% for col in list_columns %}
                <th{% if col.width %} style="width:{{ col.width }}"{% endif %}>{{ col.label }}</th>
              {% endfor %}
              <th style="width:160px;">更新日時</th>
              <th style="width:140px;">操作</th>
            </tr>
          </thead>
          <tbody>
            {% if page_obj.object_list %}
              {% for p in page_obj.object_list %}
                {% with flag=p.RequiredProduct_flg|stringformat:"s"|lower %}
                <tr class="{% if flag == 'true' or flag == '1' or flag == 'yes' or flag == 'on' or flag == '必要' or flag == 'ひつよう' or flag == '必須' %}required-row{% endif %}">
                  <td>#{{ p.id }}</td>
          
                  {% for col in list_columns %}
                    {% with val=p|get_attr:col.field %}
                      <td class="{% if col.mono %}mono{% endif %}">
                        {% if col.field == 'RequiredProduct_flg' %}
                          {# ここだけ日本語化して表示 #}
                          {% with f=val|stringformat:"s"|lower %}
                            {% if f == 'true' or f == '1' or f == 'yes' or f == 'on' or f == '必要' or f == 'ひつよう' or f == '必須' %}
                              必要
                            {% else %}
                              不要
                            {% endif %}
                          {% endwith %}
                        {% elif col.link_to_detail %}
                          <a href="{% url 'product_detail' p.id %}?vendor={{ vendor }}">{{ val }}</a>
                        {% elif col.format == 'datetime' and val %}
                          {{ val|date:"Y-m-d H:i" }}
                        {% else %}
                          {{ val }}
                        {% endif %}
                      </td>
                    {% endwith %}
                  {% endfor %}
          
                  <td>{{ p.updated_at|date:"Y-m-d H:i" }}</td>
                  <td>
                    <a class="btn btn-primary" href="{% url 'product_detail' p.id %}?vendor={{ vendor }}">詳細・編集</a>
                  </td>
                </tr>
                {% endwith %}
              {% endfor %}
            {% else %}
              <tr>
                <td colspan="{{ list_columns|length|add:3 }}" class="muted" style="padding:16px 12px;">データがありません。</td>
              </tr>
            {% endif %}
          </tbody>
        </table>
      </div>

      <!-- ページネーション -->
      <div style="display:flex; gap:6px; align-items:center; justify-content:flex-end; margin-top:12px;">
        {% if page_obj.has_previous %}
          <a class="btn" href="?page=1&vendor={{ vendor }}">« 最初</a>
          <a class="btn" href="?page={{ page_obj.previous_page_number }}&vendor={{ vendor }}">‹ 前</a>
        {% endif %}
        <span class="btn" style="background:#eef6ff; border-color:#cfe8ff;">
          {{ page_obj.number }} / {{ page_obj.paginator.num_pages }}
        </span>
        {% if page_obj.has_next %}
          <a class="btn" href="?page={{ page_obj.next_page_number }}&vendor={{ vendor }}">次 ›</a>
          <a class="btn" href="?page={{ page_obj.paginator.num_pages }}&vendor={{ vendor }}">最後 »</a>
        {% endif %}
      </div>
    </div>
  </section>

  <script>
    // ベンダー切替（GET パラメータ維持は vendor のみでOKとの前提）
    (function(){
      const sel = document.getElementById('vendor');
      if(!sel) return;
      sel.addEventListener('change', ()=>{
        const v = sel.value;
        const url = new URL(window.location.href);
        url.searchParams.set('vendor', v);
        url.searchParams.set('page', '1');
        window.location.href = url.toString();
      });
    })();
  </script>
{% endblock %}
